#!bash

gunpushed() {
  local branch remote tracking rbranch
  branch=`git symbolic-ref -q HEAD`
  if [ -n "$branch" ]; then
    branch="${branch##refs/heads/}"
    remote=`git config branch.${branch}.remote`
    tracking=`git config branch.${branch}.merge`
    if [ -n "$remote" -a -n "$tracking" ]; then
      tracking="${tracking##refs/heads/}"
      rbranch="$remote/$tracking"
      echo "UNPUSHED: git log $rbranch..$branch"
      git log $rbranch..$branch
      echo "UNPULLED: git log $branch..$rbranch"
      git log $branch..$rbranch
    fi
  fi
}

gpu() {
  local branch remote tracking
  branch=`git symbolic-ref -q HEAD`
  if [ -n "$branch" ]; then
    branch="${branch##refs/heads/}"
    remote=`git config branch.${branch}.remote`
    tracking=`git config branch.${branch}.merge`
    if [ -n "$remote" -a -n "$tracking" ]; then
      tracking="${tracking##refs/heads/}"
      echo "git push $remote $tracking"
      git push $remote $tracking
    else
      echo "** creating new remote branch $branch **"
      echo "git push -u origin $branch"
      git push -u origin $branch
    fi
  fi
}

gmerge() {
  local toMerge force branch remote n m rbranch tracking
  toMerge=$1
  force=$2
  echo "gmerge: fetching..."
  git fetch || return

  echo "gmerge: checking if current branch is up to date (use 'gmerge branch force' to skip)..."
  branch=`git symbolic-ref -q HEAD`
  if [ -z "$branch" ]; then
    echo "gmerge: not currently on a branch"
    return 1
  fi

  branch="${branch##refs/heads/}"
  remote=`git config branch.${branch}.remote`
  tracking=`git config branch.${branch}.merge`
  if [ -n "$remote" -a -n "$merge" ]; then
    tracking="${tracking##refs/heads/}"
    rbranch="$remote/$tracking"
    n=`git log --pretty=oneline $rbranch..$branch | wc -l`
    m=`git log --pretty=oneline $branch..$rbranch | wc -l`
    if [ "$n" -gt 0 -o "$m" -gt 0 ]; then
      echo "gmerge: ERROR local branch '$branch' is out of sync with remote tracking branch '$rbranch'"
      if [ -n "$force" ]; then
        echo "gmerge: ... ignoring (force option present)"
      else
        gunpushed
        return 1
      fi
    fi
  else
    echo "gmerge: can't identify remote tracking branch for local branch '$branch'"
  fi

  echo "gmerge: merging origin/$toMerge ('git merge --abort' to cancel)"
  git merge -s recursive -X patience --no-ff origin/$toMerge
}

# lited from @izs (https://gist.github.com/2897608)

# adds a remote for $nick as a remote of the current repo
ghadd () {
  local me="$(git config --get github.user)"
  [ "$me" == "" ] && echo "Please enter your github name as the github.user git config." && return 1
  # like: "git@github.com:$me/$repo.git"
  local mine="$( git config --get remote.origin.url )"
  local repo="${mine/git@github.com:$me\//}"
  local nick="$1"
  local who="$2"
  [ "$who" == "" ] && who="$nick"
  [ "$who" == "" ] && ( echo "usage: ghadd [nick] <who>" >&2 ) && return 1
  # eg: git://github.com/isaacs/jack.git
  local theirs="git://github.com/$who/$repo"
  git remote add "$nick" "$theirs"
  git fetch -a "$nick"
}

# Add the github origin remote
gho () {
  local me="$(git config --get github.user)"
  [ "$me" == "" ] && \
    echo "Please enter your github name as the github.user git config." && \
    return 1
  # like: "git@github.com:$me/$repo.git"
  local name="${1:-$(basename "$PWD")}"
  local repo="git@github.com:$me/$name"
  git remote add "origin" "$repo"
  git fetch -a "$origin"
}
